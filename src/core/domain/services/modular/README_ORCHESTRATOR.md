# üéØ CALCULATION ORCHESTRATOR - DOCUMENTACI√ìN COMPLETA

## üìã √çndice
1. [Introducci√≥n](#introducci√≥n)
2. [Arquitectura](#arquitectura)
3. [Uso B√°sico](#uso-b√°sico)
4. [Funcionalidades Avanzadas](#funcionalidades-avanzadas)
5. [Integraci√≥n con UI](#integraci√≥n-con-ui)
6. [Manejo de Errores](#manejo-de-errores)
7. [Optimizaci√≥n y Rendimiento](#optimizaci√≥n-y-rendimiento)
8. [Ejemplos Pr√°cticos](#ejemplos-pr√°cticos)

---

## üéØ Introducci√≥n

El **CalculationOrchestrator** es el componente central que coordina todos los m√≥dulos de c√°lculo de fertilidad en la aplicaci√≥n. Act√∫a como un director de orquesta que:

- üé≠ **Coordina m√∫ltiples engines** (Standard, Premium, Unified)
- üíæ **Gestiona el cache inteligente** para mejorar rendimiento
- üìä **Monitorea el performance** en tiempo real
- üîÑ **Maneja errores y recuperaci√≥n** autom√°tica
- üöÄ **Optimiza autom√°ticamente** el sistema

### ‚ú® Caracter√≠sticas Principales

- **C√°lculo Autom√°tico**: Selecciona el mejor engine autom√°ticamente
- **Cache Inteligente**: Evita c√°lculos redundantes
- **Retry System**: Recuperaci√≥n autom√°tica en caso de error
- **Batch Processing**: Procesar m√∫ltiples c√°lculos eficientemente
- **Health Monitoring**: Monitoreo continuo del sistema
- **Performance Profiling**: An√°lisis detallado de rendimiento

---

## üèóÔ∏è Arquitectura

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ           CalculationOrchestrator           ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê          ‚îÇ
‚îÇ  ‚îÇ   Cache     ‚îÇ  ‚îÇ Performance ‚îÇ          ‚îÇ
‚îÇ  ‚îÇ  Manager    ‚îÇ  ‚îÇ   Monitor   ‚îÇ          ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò          ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê          ‚îÇ
‚îÇ  ‚îÇ   Engine    ‚îÇ  ‚îÇ Calculation ‚îÇ          ‚îÇ
‚îÇ  ‚îÇ  Selector   ‚îÇ  ‚îÇ    Core     ‚îÇ          ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### üß© Componentes Integrados

- **CacheManager**: Gesti√≥n inteligente de cache
- **PerformanceMonitor**: Monitoreo y m√©tricas
- **EngineSelector**: Selecci√≥n autom√°tica de engines
- **CalculationCore**: L√≥gica de c√°lculo principal

---

## üöÄ Uso B√°sico

### 1. Importar el Orchestrator

```typescript
import { 
  calculateFertility,
  calculateFertilityFast,
  CalculationOptions,
  UserInput 
} from './CalculationOrchestrator';
```

### 2. C√°lculo B√°sico

```typescript
// Datos de entrada
const userInput: UserInput = {
  age: 30,
  cycleDuration: 28,
  infertilityDuration: 2,
  bmi: 23.5,
  hasPcos: false,
  hasOtb: false,
  endometriosisGrade: 0,
  amh: 2.5,
  tsh: 2.0,
  prolactin: 20,
  spermConcentration: 20,
  spermProgressiveMotility: 40,
  spermNormalMorphology: 6
};

// Opciones de c√°lculo
const options: CalculationOptions = {
  enableProfiling: true,
  useCache: true,
  userId: 'user123'
};

// Ejecutar c√°lculo
const result = await calculateFertility(userInput, options);

console.log('Pron√≥stico:', result.evaluation.report.numericPrognosis);
console.log('Categor√≠a:', result.evaluation.report.category);
console.log('Engine usado:', result.metadata.engineUsed);
```

### 3. C√°lculo R√°pido (Sin Metadatos)

```typescript
const quickResult = await calculateFertilityFast(userInput);
console.log('Pron√≥stico r√°pido:', quickResult.report.numericPrognosis);
```

---

## üîß Funcionalidades Avanzadas

### 1. Sistema de Retry

```typescript
import { calculateFertilityWithRetry } from './CalculationOrchestrator';

// C√°lculo con hasta 3 reintentos
const result = await calculateFertilityWithRetry(
  userInput, 
  options, 
  3  // m√°ximo 3 reintentos
);

if (result.metadata.recovered) {
  console.log('C√°lculo recuperado exitosamente');
}
```

### 2. Procesamiento por Lotes

```typescript
import { calculateFertilityBatch } from './CalculationOrchestrator';

const inputs = [userInput1, userInput2, userInput3];
const batchResult = await calculateFertilityBatch(inputs, options);

console.log('Exitosos:', batchResult.summary.successful);
console.log('Fallidos:', batchResult.summary.failed);
console.log('Tiempo promedio:', batchResult.summary.averageTime);
```

### 3. Monitoreo de Salud

```typescript
import { getSystemHealthReport } from './CalculationOrchestrator';

const health = getSystemHealthReport();
console.log('Estado general:', health.overall);
console.log('Recomendaciones:', health.recommendations);
console.log('M√©tricas:', health.metrics);
```

### 4. Optimizaci√≥n Autom√°tica

```typescript
import { optimizeModularSystem } from './CalculationOrchestrator';

const optimization = optimizeModularSystem();
console.log('Optimizaciones aplicadas:', optimization.optimizationsApplied);
console.log('Mejoras esperadas:', optimization.expectedImprovements);
```

---

## üé® Integraci√≥n con UI

### 1. Hook Personalizado

```typescript
import { useCalculationOrchestrator } from './CalculationIntegrationGuide';

function FertilityCalculator() {
  const {
    calculate,
    isCalculating,
    lastResult,
    error,
    systemHealth
  } = useCalculationOrchestrator();

  const handleCalculate = async () => {
    const result = await calculate(userInput);
    if (result) {
      // Mostrar resultado
      console.log('Resultado:', result);
    }
  };

  return (
    <View>
      <Button 
        title={isCalculating ? 'Calculando...' : 'Calcular'} 
        onPress={handleCalculate}
        disabled={isCalculating}
      />
      {error && <Text style={{color: 'red'}}>{error}</Text>}
      {lastResult && (
        <Text>Pron√≥stico: {lastResult.evaluation.report.numericPrognosis}%</Text>
      )}
    </View>
  );
}
```

### 2. Servicio de Integraci√≥n

```typescript
import { CalculationService } from './CalculationIntegrationGuide';

const calculationService = CalculationService.getInstance();

// Suscribirse a resultados
const unsubscribe = calculationService.subscribe((result) => {
  console.log('Nuevo resultado:', result);
});

// Ejecutar c√°lculo
await calculationService.calculateAndNotify(userInput, options);

// Limpiar suscripci√≥n
unsubscribe();
```

---

## üõ†Ô∏è Manejo de Errores

### 1. Categorizaci√≥n de Errores

```typescript
import { CalculationErrorHandler } from './CalculationIntegrationGuide';

try {
  const result = await calculateFertility(userInput, options);
} catch (error) {
  const handled = CalculationErrorHandler.handleError(error);
  
  console.log('Tipo de error:', handled.type);
  console.log('Mensaje:', handled.message);
  console.log('Recuperaci√≥n:', handled.recovery);
}
```

### 2. Manejo de Errores en UI

```typescript
// Mostrar error amigable al usuario
CalculationErrorHandler.showUserFriendlyError(error);
```

### 3. Errores Comunes y Soluciones

| Error | Causa | Soluci√≥n |
|-------|-------|----------|
| `NETWORK` | Conexi√≥n | Verificar conectividad |
| `VALIDATION` | Datos inv√°lidos | Revisar entrada |
| `CALCULATION` | Error en c√°lculo | Usar datos diferentes |
| `SYSTEM` | Error del sistema | Reiniciar app |

---

## ‚ö° Optimizaci√≥n y Rendimiento

### 1. Configuraci√≥n de Cache

```typescript
const options: CalculationOptions = {
  useCache: true,           // Habilitar cache
  cacheExpirationTime: 300, // 5 minutos
  userId: 'user123'         // Cache por usuario
};
```

### 2. Profiling de Performance

```typescript
const options: CalculationOptions = {
  enableProfiling: true,    // Habilitar profiling
  minConfidenceLevel: 0.8   // Nivel m√≠nimo de confianza
};

const result = await calculateFertility(userInput, options);
console.log('Tiempos por m√≥dulo:', result.debug?.moduleTimings);
```

### 3. Selecci√≥n de Engine

```typescript
const options: CalculationOptions = {
  preferredEngine: 'PREMIUM',  // Forzar engine espec√≠fico
  fallbackEngines: ['STANDARD', 'UNIFIED']  // Fallbacks
};
```

---

## üìä Ejemplos Pr√°cticos

### 1. Calculadora Completa

```typescript
import React, { useState } from 'react';
import { View, Button, Text, ActivityIndicator } from 'react-native';
import { calculateFertility, CalculationOptions } from './CalculationOrchestrator';

export function CompleteFertilityCalculator({ userInput }) {
  const [result, setResult] = useState(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  const handleCalculate = async () => {
    setLoading(true);
    setError(null);
    
    try {
      const options: CalculationOptions = {
        enableProfiling: true,
        useCache: true,
        userId: 'app_user',
        enableRecovery: true
      };

      const calculationResult = await calculateFertility(userInput, options);
      setResult(calculationResult);
      
    } catch (err) {
      setError(err.message);
    } finally {
      setLoading(false);
    }
  };

  return (
    <View style={{ padding: 20 }}>
      <Button
        title="Calcular Fertilidad"
        onPress={handleCalculate}
        disabled={loading}
      />
      
      {loading && <ActivityIndicator size="large" />}
      
      {error && (
        <Text style={{ color: 'red', marginTop: 10 }}>
          Error: {error}
        </Text>
      )}
      
      {result && (
        <View style={{ marginTop: 20 }}>
          <Text style={{ fontSize: 18, fontWeight: 'bold' }}>
            Pron√≥stico: {result.evaluation.report.numericPrognosis.toFixed(1)}%
          </Text>
          <Text>Categor√≠a: {result.evaluation.report.category}</Text>
          <Text>Engine: {result.metadata.engineUsed}</Text>
          <Text>Tiempo: {result.metadata.totalExecutionTime.toFixed(2)}ms</Text>
          {result.metadata.cacheHit && (
            <Text style={{ color: 'green' }}>‚úì Cache Hit</Text>
          )}
        </View>
      )}
    </View>
  );
}
```

### 2. Dashboard de Monitoreo

```typescript
import React, { useState, useEffect } from 'react';
import { View, Text, Button, ScrollView } from 'react-native';
import { getSystemHealthReport, getSystemStats } from './CalculationOrchestrator';

export function SystemDashboard() {
  const [health, setHealth] = useState(null);
  const [stats, setStats] = useState(null);

  const refreshStatus = () => {
    const healthData = getSystemHealthReport();
    const statsData = getSystemStats();
    
    setHealth(healthData);
    setStats(statsData);
  };

  useEffect(() => {
    refreshStatus();
    const interval = setInterval(refreshStatus, 30000); // Cada 30 segundos
    return () => clearInterval(interval);
  }, []);

  return (
    <ScrollView style={{ padding: 20 }}>
      <Text style={{ fontSize: 20, fontWeight: 'bold', marginBottom: 20 }}>
        Sistema de C√°lculo - Dashboard
      </Text>
      
      <Button title="Actualizar Estado" onPress={refreshStatus} />
      
      {health && (
        <View style={{ marginTop: 20 }}>
          <Text style={{ fontSize: 16, fontWeight: 'bold' }}>
            Estado General: {health.overall}
          </Text>
          
          <Text style={{ marginTop: 10, fontWeight: 'bold' }}>M√≥dulos:</Text>
          {Object.entries(health.modules).map(([module, status]) => (
            <Text key={module}>
              {module}: {status.status} - {status.message}
            </Text>
          ))}
          
          <Text style={{ marginTop: 10, fontWeight: 'bold' }}>M√©tricas:</Text>
          <Text>Requests totales: {health.metrics.totalRequests}</Text>
          <Text>Tasa de √©xito: {(health.metrics.successRate * 100).toFixed(1)}%</Text>
          <Text>Tiempo promedio: {health.metrics.averageResponseTime.toFixed(0)}ms</Text>
          
          {health.recommendations.length > 0 && (
            <View style={{ marginTop: 10 }}>
              <Text style={{ fontWeight: 'bold' }}>Recomendaciones:</Text>
              {health.recommendations.map((rec, index) => (
                <Text key={index}>‚Ä¢ {rec}</Text>
              ))}
            </View>
          )}
        </View>
      )}
    </ScrollView>
  );
}
```

---

## üìù Mejores Pr√°cticas

### 1. Configuraci√≥n Recomendada

```typescript
// Para uso en producci√≥n
const productionOptions: CalculationOptions = {
  enableProfiling: false,     // Desactivar en producci√≥n
  useCache: true,            // Siempre usar cache
  enableRecovery: true,      // Habilitar recuperaci√≥n
  minConfidenceLevel: 0.7,   // Nivel m√≠nimo aceptable
  userId: getCurrentUserId() // ID √∫nico por usuario
};

// Para desarrollo y debugging
const developmentOptions: CalculationOptions = {
  enableProfiling: true,     // Activar para debugging
  useCache: false,          // Desactivar para pruebas
  enableRecovery: true,     // Mantener recuperaci√≥n
  minConfidenceLevel: 0.5   // Nivel m√°s permisivo
};
```

### 2. Manejo de Estados

```typescript
// Estado de la aplicaci√≥n
interface CalculationState {
  isCalculating: boolean;
  lastResult: CalculationResult | null;
  error: string | null;
  systemHealth: 'OK' | 'WARNING' | 'ERROR';
}

// Reducer para manejo de estado
const calculationReducer = (state: CalculationState, action: any) => {
  switch (action.type) {
    case 'CALCULATION_START':
      return { ...state, isCalculating: true, error: null };
    case 'CALCULATION_SUCCESS':
      return { ...state, isCalculating: false, lastResult: action.payload };
    case 'CALCULATION_ERROR':
      return { ...state, isCalculating: false, error: action.payload };
    case 'HEALTH_UPDATE':
      return { ...state, systemHealth: action.payload };
    default:
      return state;
  }
};
```

### 3. Testing

```typescript
import { calculateFertility } from './CalculationOrchestrator';

describe('CalculationOrchestrator', () => {
  it('should calculate fertility correctly', async () => {
    const mockInput = { /* datos de prueba */ };
    const result = await calculateFertility(mockInput);
    
    expect(result.evaluation.report.numericPrognosis).toBeGreaterThan(0);
    expect(result.evaluation.report.numericPrognosis).toBeLessThanOrEqual(100);
  });
  
  it('should handle errors gracefully', async () => {
    const invalidInput = { /* datos inv√°lidos */ };
    
    await expect(calculateFertility(invalidInput)).rejects.toThrow();
  });
});
```

---

## üîó Referencias

- [Documentaci√≥n API](./API_DOCS.md)
- [Gu√≠a de Integraci√≥n](./CalculationIntegrationGuide.ts)
- [Ejemplos de Uso](./CalculationOrchestratorDemo.ts)
- [Arquitectura del Sistema](./ARCHITECTURE.md)

---

## üìû Soporte

Para dudas o problemas:
- Revisar la documentaci√≥n completa
- Verificar los ejemplos de uso
- Consultar el dashboard de monitoreo
- Contactar al equipo de desarrollo

**¬°El CalculationOrchestrator est√° listo para usar! üöÄ**
